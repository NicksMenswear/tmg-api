# TMG API Server

## Overview

This server was generated by the [OpenAPI Generator](https://openapi-generator.tech) project. By using the
[OpenAPI-Spec](https://openapis.org) from a remote server, you can easily generate a server stub.  This
is an example of building a OpenAPI-enabled Flask server.

This example uses the [Connexion](https://github.com/zalando/connexion) library on top of Flask.

## Requirements

- Python 3.12
- `pip install tox`

## Usage

To run the server, please execute the following from the root directory:

### Create virtual environment 

```bash
# Create virtual envs
tox

# Activate "tmg-dev" venv
source .tox/tmg-dev/bin/activate

# Activate "tmg-migrations" venv
source .tox/tmg-migrations/bin/activate
```

Note that pre-commit git hook will be installed as well

### Run dev server

```sh
python main.py
```

and open your browser to here:

```
http://localhost:8080/ui/
```

Your OpenAPI definition lives here:

```
http://localhost:8080/openapi.json
```

### Run tests

```sh
tox
```

#### Run integration tests

In order to run integration tests agains local db:

```sh
./test-integration.sh
```

#### Run e2e tests

```sh
./test-e2e.sh
```

run against `stg` environment and browser `firefox`:

```sh
ACTIVE_ENV=stg BROWSER=firefox ./test-e2e.sh
````

run/debug particular test

```sh
PWDEBUG=1 pytest --headed -s -k <test-function-name>
```

for example:

```sh
PWDEBUG=1 pytest --headed -s -k test_roles_persistence 
```

## Migrations with "alembic"

### Select migration environment

```shell
source .tox/tmg-migrations/bin/activate
```

### Define DB_URI for migrations

```shell
export DB_URI="postgresql+psycopg2://<USER>:<PASSWORD>@DB_URI:5432/tmg"

# Example

export DB_URI=postgresql+psycopg2://postgres:xxxxxxxxxx@tmg-db-dev-01.cfbqizbq9cdk.us-west-2.rds.amazonaws.com:5432/tmg
```

### Get List Of Migrations:

```shell
alembic history
```

### Get Current DB Version:

```shell
alembic current
```

### Generate new migration

Create the new migration based on the models change

```
alembic revision --autogenerate -m "My new migration"
```

### Apply migrations

Apply migration using `alembic upgrade head`

```shell
alembic upgrade head
```

## Scripts

More on scripts in [scripts/README.md](./scripts/README.md)